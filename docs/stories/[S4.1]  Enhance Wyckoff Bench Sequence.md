# Story:S[4.1] Enhance Wyckoff Bench Sequence and Context Benchmarks

## Overview

The goal of this story is to tighten the sequence and context benchmarks in the **Wyckoff Fast Bench** harness and prepare the codebase for eventual production.  We will address three key improvements:

1. **Low‑sample warnings and sequence tuning.**  Add warnings when a sequence has too few examples, expose per‑sequence `max_gap` tuning, and allow problematic sequences to be disabled via configuration.  This prevents misleading statistics from extremely small datasets and makes the harness flexible enough to accommodate new data.
2. **Expanded contextual analysis.**  Include **BC** (Buying Climax) and **SPRING** in the context‑aware event benchmark alongside SOS and SOW, so we can see how these events behave in different regimes.
3. **Bootstrap confidence intervals.**  Optionally compute bootstrap confidence intervals for median forward returns to quantify uncertainty around each metric.  Bootstrapping resamples the data many times with replacement to build an empirical distribution of the statistic of interest [oai_citation:0‡acclab.github.io](https://acclab.github.io/bootstrap-confidence-intervals.html#:~:text=Bootstrap%20resampling%20gives%20us%20two,important%20benefits).

These changes preserve the existing benchmarks (baseline, incremental, transition, sequence, contextual) and do not alter the underlying detection logic.  They simply improve reporting, configurability and statistical rigor.

## Files Added/Modified

The following files will be created or modified.  All new modules follow the same coding standards as the existing harness and are integrated into the orchestrator:

| File | Status | Description |
|------|--------|-------------|
| **config/run_config.yaml** | *Modified* | Expose new tunable parameters (`sequence_max_gap`, `sequence_max_gap_map`, `disabled_sequences`, `context_events`, `bootstrap_ci_enabled`, `bootstrap_resamples`).  Comment out any existing parameters that are not referenced in code. |
| **harness/sequence_labels.py** | *Modified* | Add support for a per‑sequence `max_gap` dictionary and a `disabled_sequences` list.  If a sequence is disabled, detection is skipped. |
| **harness/run.py** | *Modified* | (1) Read new config parameters. (2) When running the sequence benchmark, collect sample counts and print a warning if any sequence has fewer than `min_sequence_samples` events (default = 50). (3) Pass custom `max_gap` and disabled list to `sequence_labels.label_event_sequences`. (4) In contextual analysis, include BC and SPRING in the list of events. (5) Condition output writing on whether bootstrap confidence intervals are enabled. |
| **harness/contextual_event_eval.py** | *Modified* | Add an optional `events` argument so that callers can specify which event types to include (default now includes SOS, SOW, BC, SPRING). |
| **harness/eval.py** | *Modified* | Add a `_bootstrap_ci` helper and include `median_ci_low`/`median_ci_high` in summary outputs when `bootstrap_ci_enabled` is true.  Use 1000 resamples by default; this can be overridden in the config. |
| **docs/story_sequence_context_ci.md** | *New* | A user‑facing markdown document describing how to run the updated benchmarks, interpret low‑sample warnings and bootstrap intervals, and tune parameters. |

## Detailed Implementation Notes

### 1. Low‑Sample Warnings and Sequence Tuning

* **Per‑sequence `max_gap`.**  Modify `sequence_labels.label_event_sequences` to accept a `max_gap_map: dict[str, int]` and a `max_gap_default: int`.  For each sequence pattern, look up a custom gap or fall back to the default.  In `run.py`, read this mapping from the YAML configuration.  For example:

  ```yaml
  # sequence detection parameters
  sequence_max_gap_default: 30
  sequence_max_gap_map:
    SEQ_ACCUM_BREAKOUT: 20    # tighten gap for this sequence
    SEQ_MARKDOWN_START: 40    # loosen gap for markdown start
  disabled_sequences: ["SEQ_ACCUM_BREAKOUT"] # skip detection for this sequence
  min_sequence_samples: 50    # warn if a sequence has fewer than 50 occurrences
	•	Disabled sequences.  Pass disabled_sequences from config into label_event_sequences so that specific patterns (e.g. SEQ_ACCUM_BREAKOUT) are not detected until more data is available.
	•	Sample size warnings.  After running the sequence benchmark in run.py, compute a value count of the event column (which represents the sequence identifiers) and compare against min_sequence_samples.  If any sequence has fewer than the threshold, log a warning (e.g. logging.warning("Low sample sequence: {seq} ({count} events)")).
	•	Comment unused config parameters.  Review the YAML and comment out keys that are not read by any module.  For example, if spring_after_sc_ratio remains unused, add a # unused comment next to it.  This reduces confusion when tuning parameters.

2. Extended Contextual Analysis
	•	Configurable event list.  In run.py, add a context_events list to the YAML.  If unspecified, default to ['SOS', 'SOW', 'BC', 'SPRING'].  Modify the call to contextual_event_eval.attach_prior_regime and the subsequent filtering to include any event whose event column is in this list.  Update contextual_event_eval.attach_prior_regime to accept an optional events: List[str] argument to filter in the helper itself.
	•	BC and SPRING logic.  These additions allow the contextual benchmark to produce results such as BC_after_MARKUP (risk‑off) and SPRING_after_DISTRIBUTION (failed spring).  Including them helps validate whether BC and SPRING behave as expected in various regimes.

3. Bootstrap Confidence Intervals
	•	Implementation in eval.py.  Add a function _bootstrap_ci(data: np.ndarray, n_bootstrap: int = 1000, ci: float = 0.95) -> tuple[float, float] that performs bootstrap resampling and returns the lower and upper bounds of the specified percentile interval.  The process works by drawing n_bootstrap samples with replacement from the data and computing the median of each resample.  The 2.5th and 97.5th percentiles (for a 95 % CI) of these medians form the confidence interval boundaries ￼.
	•	Toggle via config.  Add a bootstrap_ci_enabled: bool flag in the YAML.  When true, modify the summarization function to compute and include median_ci_low and median_ci_high in the results.  Also add bootstrap_resamples to set the number of bootstrap iterations (default 1000).  Because bootstrap is computationally heavy, leave it disabled by default unless explicitly enabled for research runs.

4. Documentation
	•	Create docs/story_sequence_context_ci.md describing:
	•	Why low‑sample warnings are necessary.
	•	How to adjust max_gap and disable sequences.
	•	How to interpret BC and SPRING contextual results.
	•	What bootstrap confidence intervals mean (brief explanation that bootstrapping resamples the data and uses the 2.5th and 97.5th percentiles to estimate the confidence interval ￼).
	•	How to enable and configure the new parameters in run_config.yaml.

Acceptance Criteria
	•	New config parameters appear in config/run_config.yaml with clear descriptions and default values.  Unused keys are commented out.
	•	The sequence benchmark prints warnings when any sequence has fewer than min_sequence_samples events, and respects custom max_gap_map and disabled_sequences settings.
	•	The contextual benchmark includes BC and SPRING by default and can be customized via context_events.
	•	The evaluation summary reports include median_ci_low and median_ci_high when bootstrap_ci_enabled is true.
	•	The new documentation file (docs/story_sequence_context_ci.md) explains how to use these features and interpret the results. 